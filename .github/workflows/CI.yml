name: CI

on: [push, pull_request]

jobs:
  ci:
    runs-on: ubuntu-latest

    steps:

      # -------------------------
      # 1) Checkout repository
      # -------------------------
      - name: Checkout repository
        uses: actions/checkout@v4

      # -------------------------
      # 2) Install clang-format
      # -------------------------
      - name: Install clang-format
        run: |
          sudo apt-get update
          sudo apt-get install -y clang-format

      - name: Run lint (clang-format check only)
        run: |
          # dry-run formatting check (won't modify files)
          find . -name "*.c" -o -name "*.h" | xargs --no-run-if-empty clang-format -style=LLVM -n || true

      # -------------------------
      # 3) Optional tests
      # -------------------------
      - name: Run tests if Makefile exists
        run: |
          if [ -f Makefile ]; then
            make test || true
          else
            echo "No Makefile found â€” skipping tests"
          fi

      # -------------------------
      # 4) Install & run cppcheck
      # -------------------------
      - name: Install cppcheck
        run: |
          sudo apt-get update
          sudo apt-get install -y cppcheck

      - name: Run cppcheck (produce xml + txt)
        run: |
          # produce XML (machine) and TXT (human) reports; do not fail pipeline on warnings
          cppcheck --enable=warning,style,performance --xml 2> cppcheck.xml || true
          cppcheck --enable=warning,style,performance 2> cppcheck.txt || true
          echo "=== cppcheck preview ==="
          head -n 20 cppcheck.txt || true

      # -------------------------
      # 5) Install & run flawfinder ONLY on target folder
      # -------------------------
      - name: Install flawfinder
        run: |
          sudo apt-get update
          sudo apt-get install -y flawfinder

      - name: Run flawfinder on classic-platform/diagnostic/Dcm/src only
        env:
          PYTHONUTF8: 0
          LC_ALL: C.ISO-8859-1
        run: |
          TARGET="classic-platform/diagnostic/Dcm/src"

          echo "Target path: $TARGET"
          # If target missing, show repo tree so we can debug in logs; STILL create empty outputs so artifacts upload
          if [ ! -d "$TARGET" ]; then
            echo "WARNING: target directory not found: $TARGET"
            echo "Repo top-level listing:"
            ls -la || true
            echo "Recursive (top 2 levels):"
            find . -maxdepth 2 -type d -print || true

            # ensure files exist so artifacts always have something
            echo "No files scanned (target missing)" > flawfinder.txt
            touch cppcheck.txt cppcheck.xml
            exit 0
          fi

          # Find .c/.h files under the target and run flawfinder on them (avoid versions without --exclude-dir)
          # Use -print0 and xargs -0 to safely handle spaces/newlines in filenames
          find "$TARGET" -type f \( -name '*.c' -o -name '*.h' \) -print0 \
            | xargs -0 -r flawfinder --quiet --minlevel=3 --singleline --dataonly > flawfinder.txt || true

          # if flawfinder produced no hits and file is empty, write a message (so artifact isn't zero-length)
          if [ ! -s flawfinder.txt ]; then
            echo "No vulnerability hits found by flawfinder in $TARGET" > flawfinder.txt
          fi

          echo "=== flawfinder preview ==="
          head -n 200 flawfinder.txt || true

      # -------------------------
      # 6) Confirm files exist and list them (debug helper)
      # -------------------------
      - name: Confirm reports exist (ls)
        run: |
          echo "--- current workspace files (top-level) ---"
          ls -la || true
          echo "--- find generated reports ---"
          find . -type f -name 'flawfinder.txt' -o -name 'cppcheck.txt' -o -name 'cppcheck.xml' -print || true
          echo "--- show first lines of reports ---"
          echo "----- flawfinder.txt -----"
          head -n 50 flawfinder.txt || true
          echo "----- cppcheck.txt -----"
          head -n 50 cppcheck.txt || true
          echo "----- cppcheck.xml (first 50 lines) -----"
          head -n 50 cppcheck.xml || true

      # -------------------------
      # 7) Upload artifacts (always)
      # -------------------------
      - name: Upload analysis reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: analysis-reports
          path: |
            cppcheck.xml
            cppcheck.txt
            flawfinder.txt
