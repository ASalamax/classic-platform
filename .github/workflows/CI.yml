name: CI

on: [push, pull_request]

jobs:
  ci:
    runs-on: ubuntu-latest

    steps:

      # Checkout repository
      - name: Checkout repository
        uses: actions/checkout@v4

      # Install and run clang-format as a lint check (dry-run)
      - name: Install clang-format
        run: |
          sudo apt-get update
          sudo apt-get install -y clang-format

      - name: Run lint (clang-format)
        run: |
          find . -name "*.c" -o -name "*.h" | xargs --no-run-if-empty clang-format -style=LLVM -n || true

      # Optional tests if Makefile exists
      - name: Run tests if Makefile exists
        run: |
          if [ -f Makefile ]; then
            make test || true
          else
            echo "No tests found â€” skipping."
          fi

      # Install and run cppcheck (produce xml and txt)
      - name: Install cppcheck
        run: sudo apt-get install -y cppcheck

      - name: Run cppcheck
        run: |
          cppcheck --enable=warning,style,performance --xml 2> cppcheck.xml || true
          cppcheck --enable=warning,style,performance 2> cppcheck.txt || true
          echo "=== cppcheck preview ==="
          head -n 20 cppcheck.txt || true

      # Install flawfinder and run it in a single safe line
      - name: Install flawfinder
        run: sudo apt-get install -y flawfinder

      - name: Run flawfinder (safe single-line)
        env:
          PYTHONUTF8: 0
          LC_ALL: C.ISO-8859-1
        run: |
          flawfinder --quiet --minlevel=3 --singleline --dataonly --exclude-dir=.git --exclude-dir=.github --exclude-dir=3rdparty --exclude-dir=Generated --exclude-dir=communication/lwip-2.0.3 --exclude-dir=ArcticCore . > flawfinder.txt || true
          echo "=== flawfinder preview ==="
          head -n 50 flawfinder.txt || true

      # Always upload artifacts
      - name: Upload analysis reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: analysis-reports
          path: |
            **/cppcheck.xml
            **/cppcheck.txt
            **/flawfinder.txt
