name: CI                     # Name of the workflow shown in GitHub Actions

on: [push, pull_request]     # Trigger workflow on every push and pull request

jobs:
  ci:                        # Job name
    runs-on: ubuntu-latest   # GitHub runner OS

    steps:                   # List of steps to execute

      # ----------------------------------------------------
      # STEP 1 — CHECKOUT REPOSITORY
      # ----------------------------------------------------
      - name: Checkout repo
        uses: actions/checkout@v4   # Built-in action to pull your code into the runner


      # ----------------------------------------------------
      # STEP 2 — LINT (clang-format)
      # ----------------------------------------------------
      - name: Install clang-format
        run: sudo apt-get update && sudo apt-get install -y clang-format
        # - Updates package list
        # - Installs clang-format (used for formatting/linting C code)

      - name: Run lint (clang-format)
        run: |
          # find . → search for all .c and .h files
          # clang-format -n → check formatting (does NOT modify)
          # -style=LLVM → default formatting style
          find . -name "*.c" -o -name "*.h" | xargs clang-format -style=LLVM -n


      # ----------------------------------------------------
      # STEP 3 — TESTS (optional)
      # ----------------------------------------------------
      - name: Run tests if available
        run: |
          # Check if Makefile exists
          if [ -f Makefile ]; then
            # Run "make test" if defined
            make test || true
            # "|| true" prevents pipeline failure if tests fail
          else
            echo "No tests found — skipping"
          fi


      # ----------------------------------------------------
      # STEP 4 — STATIC ANALYSIS (cppcheck)
      # ----------------------------------------------------
      - name: Install cppcheck
        run: sudo apt-get install -y cppcheck
        # Installs C static analysis tool

      - name: Run cppcheck
        run: |
          # Generate XML report (machine readable)
          cppcheck --enable=warning,style,performance --xml 2> cppcheck.xml || true
          
          # Generate TXT report (easy to read)
          cppcheck --enable=warning,style,performance 2> cppcheck.txt || true

          # "|| true" ensures CI doesn't fail due to warnings


      # ----------------------------------------------------
      # STEP 5 — VULNERABILITY ANALYSIS (flawfinder)
      # ----------------------------------------------------
      - name: Install flawfinder
        run: sudo apt-get install -y flawfinder
        # Installs flawfinder (security/vulnerability scanner)

      - name: Run flawfinder
        run: |
          # Run vulnerability check, output results into text file
          # --minlevel=1 shows all levels of findings
          flawfinder --minlevel=1 . > flawfinder.txt || true
          # "|| true" keeps CI green even if issues exist


      # ----------------------------------------------------
      # STEP 6 — UPLOAD REPORTS (Artifacts)
      # ----------------------------------------------------
      - name: Upload analysis reports
        uses: actions/upload-artifact@v4  # Upload files to GitHub Actions artifacts
        with:
          name: analysis-reports          # Folder name for downloadable artifacts
          path: |                         # Files included
            cppcheck.xml                  # Static analysis (XML)
            cppcheck.txt                  # Static analysis (text format)
            flawfinder.txt                # Vulnerability analysis
