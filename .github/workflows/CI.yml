name: CI

on: [push, pull_request]

jobs:
  ci:
    runs-on: ubuntu-latest

    steps:
    # ----------------------------------------------------
    # STEP 1 — CHECKOUT
    # ----------------------------------------------------
    - name: Checkout repository
      uses: actions/checkout@v4

    # ----------------------------------------------------
    # STEP 2 — LINT (clang-format)
    # ----------------------------------------------------
    - name: Install clang-format
      run: |
        sudo apt-get update
        sudo apt-get install -y clang-format

    - name: Run lint
      run: |
        find . -name "*.c" -o -name "*.h" | xargs --no-run-if-empty clang-format -style=LLVM -n || true

    # ----------------------------------------------------
    # STEP 3 — TESTS (optional Makefile)
    # ----------------------------------------------------
    - name: Run tests if Makefile exists
      run: |
        if [ -f Makefile ]; then
          make test || true
        else
          echo "No tests found — skipping."
        fi

    # ----------------------------------------------------
    # STEP 4 — STATIC ANALYSIS (cppcheck)
    # ----------------------------------------------------
    - name: Install cppcheck
      run: sudo apt-get install -y cppcheck

    - name: Run cppcheck
      run: |
        cppcheck --enable=warning,style,performance --xml 2> cppcheck.xml || true
        cppcheck --enable=warning,style,performance 2> cppcheck.txt || true

        echo "=== cppcheck preview ==="
        head -n 20 cppcheck.txt || true

    # ----------------------------------------------------
    # STEP 5 — FLAWFINDER (ONLY SCAN YOUR TARGET DIR)
    # ----------------------------------------------------
    - name: Install flawfinder
      run: sudo apt-get install -y flawfinder

    - name: Run flawfinder ONLY on classic-platform/diagnostic/Dcm/src
      env:
        PYTHONUTF8: 0
        LC_ALL: C.ISO-8859-1
      run: |
        TARGET="classic-platform/diagnostic/Dcm/src"

        # Verify target exists
        if [ ! -d "$TARGET" ]; then
          echo "ERROR: Target directory does not exist: $TARGET"
          ls -R .
          exit 0
        fi

        # Find .c and .h files ONLY in the target dir
        find "$TARGET" -type f \( -name "*.c" -o -name "*.h" \) -print0 | \
          xargs -0 flawfinder --quiet --minlevel=3 --singleline --dataonly > flawfinder.txt || true

        echo "=== flawfinder (previe
