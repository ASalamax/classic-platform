name: CI

on: [push, pull_request]

jobs:
  ci:
    runs-on: ubuntu-latest

    steps:

      # ----------------------------------------------------
      # STEP 1 — CHECKOUT REPOSITORY
      # ----------------------------------------------------
      - name: Checkout repository
        uses: actions/checkout@v4

      # ----------------------------------------------------
      # STEP 2 — LINT (clang-format)
      # ----------------------------------------------------
      - name: Install clang-format
        run: |
          sudo apt-get update
          sudo apt-get install -y clang-format

      - name: Run lint
        run: |
          # check formatting of C files (dry-run)
          find . -name "*.c" -o -name "*.h" | xargs --no-run-if-empty clang-format -style=LLVM -n || true

      # ----------------------------------------------------
      # STEP 3 — OPTIONAL TESTS
      # ----------------------------------------------------
      - name: Run tests if Makefile exists
        run: |
          if [ -f Makefile ]; then
            make test || true
          else
            echo "No tests found — skipping."
          fi

      # ----------------------------------------------------
      # STEP 4 — STATIC ANALYSIS (cppcheck)
      # ----------------------------------------------------
      - name: Install cppcheck
        run: sudo apt-get install -y cppcheck

      - name: Run cppcheck
        run: |
          # produce XML (machine) and TXT (human) reports; keep pipeline green
          cppcheck --enable=warning,style,performance --xml 2> cppcheck.xml || true
          cppcheck --enable=warning,style,performance 2> cppcheck.txt || true
          echo "=== cppcheck (preview) ==="
          head -n 20 cppcheck.txt || true

      # ----------------------------------------------------
      # STEP 5 — VULNERABILITY ANALYSIS (Flawfinder) — SAFE
      # ----------------------------------------------------
      - name: Install flawfinder
        run: sudo apt-get install -y flawfinder

      - name: Create and run flawfinder script (safe)
        run: |
          # create scripts dir
          mkdir -p .github/scripts

          # write a small, robust script using a here-doc (single-quoted to avoid variable expansion)
          cat > .github/scripts/run_flawfinder.sh <<'SCRIPT'
#!/usr/bin/env bash
set -euo pipefail

# allow non-UTF8 files to be processed by Python
export PYTHONUTF8=0
export LC_ALL=C.ISO-8859-1

# directories to exclude from scan (adjust if needed)
EXCLUDES=(
  --exclude-dir=.git
  --exclude-dir=.github
  --exclude-dir=3rdparty
  --exclude-dir=Generated
  --exclude-dir=communication/lwip-2.0.3
  --exclude-dir=ArcticCore
)

# build exclude args
EXCLUDE_ARGS=""
for e in "${EXCLUDES[@]}"; do
  EXCLUDE_ARGS="$EXCLUDE_ARGS $e"
done

# run flawfinder:
#  --quiet      : minimal banners
#  --minlevel=3 : show only medium/high/critical (3-5)
#  --singleline : one finding per line (easy parsing)
#  --dataonly   : no headers/footers
# output written to flawfinder.txt; || true keeps workflow green
flawfinder --quiet --minlevel=3 --singleline --dataonly $EXCLUDE_ARGS . > flawfinder.txt || true

# preview (put into logs)
echo "=== flawfinder preview ==="
head -n 200 flawfinder.txt || true
SCRIPT

          # make it executable and run it
          chmod +x .github/scripts/run_flawfinder.sh
          .github/scripts/run_flawfinder.sh

      # ----------------------------------------------------
      # STEP 6 — ALWAYS UPLOAD REPORTS AS ARTIFACTS
      # ----------------------------------------------------
      - name: Upload analysis reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: analysis-reports
          path: |
            **/cppcheck.xml
            **/cppcheck.txt
            **/flawfinder.txt
