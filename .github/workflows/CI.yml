name: CI

on: [push, pull_request]

jobs:
  ci:
    runs-on: ubuntu-latest

    steps:
    # ----------------------------------------------------
    # 1) CHECKOUT
    # ----------------------------------------------------
    - name: Checkout repository
      uses: actions/checkout@v4

    # ----------------------------------------------------
    # 2) Install tools
    # ----------------------------------------------------
    - name: Install tools
      run: |
        sudo apt-get update
        sudo apt-get install -y clang-format cppcheck flawfinder

    # ----------------------------------------------------
    # 3) Lint (clang-format)
    # ----------------------------------------------------
    - name: Run lint
      run: |
        find . -name "*.c" -o -name "*.h" | xargs --no-run-if-empty clang-format -style=LLVM -n || true

    # ----------------------------------------------------
    # 4) Tests if Makefile exists
    # ----------------------------------------------------
    - name: Run tests if Makefile exists
      run: |
        if [ -f Makefile ]; then
          make test || true
        else
          echo "No tests found — skipping."
        fi

    # ----------------------------------------------------
    # 5) Static analysis (cppcheck)
    # ----------------------------------------------------
    - name: Run cppcheck (produce xml + txt)
      run: |
        cppcheck --enable=warning,style,performance --xml 2> cppcheck.xml || true
        cppcheck --enable=warning,style,performance 2> cppcheck.txt || true
        echo "=== cppcheck preview ==="
        head -n 20 cppcheck.txt || true

    # ----------------------------------------------------
    # 6) Run flawfinder ONLY on Safety_Queue.c
    # ----------------------------------------------------
    - name: Run flawfinder on datastructures/Safety_Queue/src/Safety_Queue.c
      env:
        PYTHONUTF8: 0
        LC_ALL: C.ISO-8859-1
      run: |
        TARGET="safety_security/WdgM/src"

        echo "Scanning file: $TARGET"

        # verify file exists
        if [ ! -f "$TARGET" ]; then
          echo "ERROR: File not found: $TARGET"
          echo "Repo file list:"
          find . -type f -name 'Safety_Queue.c' -print || true
          echo "File not found — creating fallback flawfinder.txt"
          echo "File '$TARGET' not found in repo." > flawfinder.txt
          exit 0
        fi

        # run flawfinder on that single file
        flawfinder --quiet --minlevel=1 --singleline --dataonly "$TARGET" > flawfinder.txt || true

        # if empty, add a message (artifact must not be empty)
        if [ ! -s flawfinder.txt ]; then
          echo "No vulnerabilities detected in $TARGET" > flawfinder.txt
        fi

        echo "=== flawfinder preview ==="
        head -n 50 flawfinder.txt || true

    # ----------------------------------------------------
    # 7) Confirm files exist
    # ----------------------------------------------------
    - name: Confirm reports exist
      run: |
        echo "--- report files ---"
        ls -la flawfinder.txt cppcheck.txt cppcheck.xml || true
        echo "--- flawfinder preview ---"
        head -n 50 flawfinder.txt || true

    # ----------------------------------------------------
    # 8) Upload artifacts
    # ----------------------------------------------------
    - name: Upload analysis reports
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: analysis-reports
        path: |
          cppcheck.xml
          cppcheck.txt
          flawfinder.txt
