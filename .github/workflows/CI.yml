name: CI

on: [push, pull_request]

jobs:
  ci:
    runs-on: ubuntu-latest

    steps:

      # ----------------------------------------------------
      # STEP 1 — CHECKOUT REPOSITORY
      # ----------------------------------------------------
      - name: Checkout repository
        uses: actions/checkout@v4

      # ----------------------------------------------------
      # STEP 2 — LINT (clang-format)
      # ----------------------------------------------------
      - name: Install clang-format
        run: |
          sudo apt-get update
          sudo apt-get install -y clang-format

      - name: Run lint
        run: |
          # check formatting of C files (dry-run)
          find . -name "*.c" -o -name "*.h" | xargs --no-run-if-empty clang-format -style=LLVM -n || true

      # ----------------------------------------------------
      # STEP 3 — OPTIONAL TESTS
      # ----------------------------------------------------
      - name: Run tests if Makefile exists
        run: |
          if [ -f Makefile ]; then
            make test || true
          else
            echo "No tests found — skipping."
          fi

      # ----------------------------------------------------
      # STEP 4 — STATIC ANALYSIS (cppcheck)
      # ----------------------------------------------------
      - name: Install cppcheck
        run: sudo apt-get install -y cppcheck

      - name: Run cppcheck
        run: |
          mkdir -p reports
          # produce XML (machine) and TXT (human) reports; keep pipeline green
          cppcheck --enable=warning,style,performance --xml 2> reports/cppcheck.xml || true
          cppcheck --enable=warning,style,performance 2> reports/cppcheck.txt || true
          echo "=== cppcheck (preview) ==="
          head -n 20 reports/cppcheck.txt || true

      # ----------------------------------------------------
      # STEP 5 — VULNERABILITY ANALYSIS (Flawfinder)
      # ----------------------------------------------------
      - name: Install flawfinder
        run: sudo apt-get install -y flawfinder

      - name: Run flawfinder
        run: |
          mkdir -p reports

          # Force Flawfinder to accept non-UTF8 encodings
          export PYTHONUTF8=0
          export LC_ALL=C.ISO-8859-1

          # Human-readable text report
          flawfinder --minlevel=2 --quiet . > reports/flawfinder.txt || true

          # HTML formatted report
          flawfinder --minlevel=2 --html --quiet . > reports/flawfinder.html || true

          echo "=== flawfinder (preview) ==="
          head -n 50 reports/flawfinder.txt || true

      # ----------------------------------------------------
      # STEP 6 — ALWAYS UPLOAD REPORTS AS ARTIFACTS
      # ----------------------------------------------------
      - name: Upload analysis reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: analysis-reports
          path: |
            reports/cppcheck.xml
            reports/cppcheck.txt
            reports/flawfinder.txt
            reports/flawfinder.html
